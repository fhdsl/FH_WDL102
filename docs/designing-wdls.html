<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Designing WDLs | WDL102: Designing, Testing and Optimizing Workflows</title>
  <meta name="description" content="A getting started guide to designing and testing WDL workflows" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Designing WDLs | WDL102: Designing, Testing and Optimizing Workflows" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A getting started guide to designing and testing WDL workflows" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Designing WDLs | WDL102: Designing, Testing and Optimizing Workflows" />
  
  <meta name="twitter:description" content="A getting started guide to designing and testing WDL workflows" />
  



<meta name="date" content="2022-12-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon" />
<link rel="prev" href="introduction.html"/>
<link rel="next" href="developing-testing-and-scaling-workflows.html"/>
<script src="libs/header-attrs-2.10/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>




<link rel="stylesheet" href="assets/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<a href="https://hutchdatascience.org/" target="_blank"><img src="assets/big-dasl-stacked.png" style="width: 80%; padding-left: 15px; padding-top: 8px;"</a>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About this Guide</a></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#what-is-wdl"><i class="fa fa-check"></i><b>1.1</b> What is WDL?</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#openwdl"><i class="fa fa-check"></i><b>1.1.1</b> OpenWDL</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#documentation-about-the-wdl-spec"><i class="fa fa-check"></i><b>1.1.2</b> Documentation about the WDL Spec</a></li>
<li class="chapter" data-level="1.1.3" data-path="introduction.html"><a href="introduction.html#tools-to-edit-wdl"><i class="fa fa-check"></i><b>1.1.3</b> Tools to Edit WDL</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#what-is-a-wdl-engine"><i class="fa fa-check"></i><b>1.2</b> What Is a WDL Engine?</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#why-use-wdl-for-my-research"><i class="fa fa-check"></i><b>1.3</b> Why use WDL for my research?</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="introduction.html"><a href="introduction.html#abstracting-storage-and-computing-details"><i class="fa fa-check"></i><b>1.3.1</b> Abstracting Storage and Computing Details</a></li>
<li class="chapter" data-level="1.3.2" data-path="introduction.html"><a href="introduction.html#reproducibility-and-portability"><i class="fa fa-check"></i><b>1.3.2</b> Reproducibility and Portability</a></li>
<li class="chapter" data-level="1.3.3" data-path="introduction.html"><a href="introduction.html#software-and-environments"><i class="fa fa-check"></i><b>1.3.3</b> Software and Environments</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="designing-wdls.html"><a href="designing-wdls.html"><i class="fa fa-check"></i><b>2</b> Designing WDLs</a>
<ul>
<li class="chapter" data-level="2.1" data-path="designing-wdls.html"><a href="designing-wdls.html#writing-workflows"><i class="fa fa-check"></i><b>2.1</b> Writing Workflows</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="designing-wdls.html"><a href="designing-wdls.html#design-recommendations"><i class="fa fa-check"></i><b>2.1.1</b> Design Recommendations</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="designing-wdls.html"><a href="designing-wdls.html#customizing-workflow-runs"><i class="fa fa-check"></i><b>2.2</b> Customizing Workflow Runs</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="designing-wdls.html"><a href="designing-wdls.html#workflow-options"><i class="fa fa-check"></i><b>2.2.1</b> Workflow Options</a></li>
<li class="chapter" data-level="2.2.2" data-path="designing-wdls.html"><a href="designing-wdls.html#runtime-defaults"><i class="fa fa-check"></i><b>2.2.2</b> Runtime Defaults</a></li>
<li class="chapter" data-level="2.2.3" data-path="designing-wdls.html"><a href="designing-wdls.html#call-caching"><i class="fa fa-check"></i><b>2.2.3</b> Call Caching</a></li>
<li class="chapter" data-level="2.2.4" data-path="designing-wdls.html"><a href="designing-wdls.html#workflow-failure-mode"><i class="fa fa-check"></i><b>2.2.4</b> Workflow Failure Mode</a></li>
<li class="chapter" data-level="2.2.5" data-path="designing-wdls.html"><a href="designing-wdls.html#copying-outputs"><i class="fa fa-check"></i><b>2.2.5</b> Copying outputs</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html"><i class="fa fa-check"></i><b>3</b> Developing, Testing and Scaling Workflows</a>
<ul>
<li class="chapter" data-level="3.1" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#creating-an-inputs-template"><i class="fa fa-check"></i><b>3.1</b> Creating an Inputs template</a></li>
<li class="chapter" data-level="3.2" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#approaches-to-testing-and-development"><i class="fa fa-check"></i><b>3.2</b> Approaches to Testing and Development</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#start-from-a-template"><i class="fa fa-check"></i><b>3.2.1</b> Start from a template</a></li>
<li class="chapter" data-level="3.2.2" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#chose-software-modules"><i class="fa fa-check"></i><b>3.2.2</b> Chose Software Modules</a></li>
<li class="chapter" data-level="3.2.3" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#add-tasks"><i class="fa fa-check"></i><b>3.2.3</b> Add Tasks</a></li>
<li class="chapter" data-level="3.2.4" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#scale-up-inputs"><i class="fa fa-check"></i><b>3.2.4</b> Scale Up Inputs</a></li>
<li class="chapter" data-level="3.2.5" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#prep-for-other-platforms-and-sharing"><i class="fa fa-check"></i><b>3.2.5</b> Prep for Other Platforms and Sharing</a></li>
<li class="chapter" data-level="3.2.6" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#testing-input-availability"><i class="fa fa-check"></i><b>3.2.6</b> Testing Input Availability</a></li>
<li class="chapter" data-level="3.2.7" data-path="developing-testing-and-scaling-workflows.html"><a href="developing-testing-and-scaling-workflows.html#scaling-up-moving-to-the-cloud"><i class="fa fa-check"></i><b>3.2.7</b> Scaling Up, Moving to the Cloud</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="wdl-at-fred-hutch.html"><a href="wdl-at-fred-hutch.html"><i class="fa fa-check"></i><b>4</b> WDL at Fred Hutch</a></li>
<li class="chapter" data-level="" data-path="about-the-authors.html"><a href="about-the-authors.html"><i class="fa fa-check"></i>About the Authors</a></li>
<li class="divider"></li>
<p style="text-align:center;"> <a href="https://github.com/jhudsl/OTTR_Template" target="blank" > This content was published with</a> <a href="https://bookdown.org/" target="blank"> bookdown by: </a> </p>
<p style="text-align:center;"> <a href="http://hutchdatascience.org/"> The Fred Hutch Data Science Lab </a></p>
<p style="text-align:center; font-size: 12px;"> <a href="https://github.com/rstudio4edu/rstudio4edu-book/"> Style adapted from: rstudio4edu-book </a> <a href ="https://creativecommons.org/licenses/by/2.0/"> (CC-BY 2.0) </a></p>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">WDL102: Designing, Testing and Optimizing Workflows</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<head>
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=10.0,initial-scale=1.0">
  <!--script src="https://kit.fontawesome.com/6a26f47516.js"></script-->
  <!--<script src="assets/hideOutput.js"></script>-->
  <link href="assets/style.css" rel="stylesheet">
</head>
        


<div class="hero-image-container"> 
  <img class= "hero-image" src="assets/dasl_thin_main_image.png">
</div>
<div id="designing-wdls" class="section level1" number="2">
<h1><span class="header-section-number">Chapter 2</span> Designing WDLs</h1>
<p>The “Getting Started with WDL” and “WDL Script Components” sections of <a href="https://wdl-docs.readthedocs.io/en/stable/">the OpenWDL docs site</a> provides a useful background into the essential parts of WDL you’ll need to learn to start designing your own WDLs.</p>
<p>A very useful way to begin learning how to write a WDL is actually to take a WDL that you know “works” in that it has the required formatting and structure to be executed by a WDL engine, and edit it. We have created a repository with <a href="https://github.com/FredHutch/wdl-test-workflows">test workflows</a> in it that can serve as a basis to get started.</p>
<div id="writing-workflows" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Writing Workflows</h2>
<p>WDL is intended to be a relatively easy to read workflow language. There are other workflow languages and workflow managers that run them, but WDL was/is primarily intended to be shared and interpreted by others that may or may not have experience with any given domain-specific language (like Nextflow). Writing workflows in WDL, therefore, has a fairly low barrier to entry for those of us new to writing workflows.</p>
<p>The basics of this workflow language includes a similar pattern where you specify workflow inputs, the order of tasks and how they pass data between them, and which files are the outputs of the workflow itself. Here is an example of a single-task workflow that takes some inputs, runs <code>bwa mem</code>, then outputs the resulting bam file and it’s index.</p>
<pre><code>version 1.0
workflow myWorkflowName {
  input {
    String sample_name = &quot;sample1&quot;
    File myfastq = &quot;/path/to/myfastq.fastq.gz&quot;
  }

  call BwaMem {
    input:
      input_fastq = myfastq,
      base_file_name = sample_name,
      ref_fasta = &quot;hg19.fasta.fa&quot;
      ref_fasta_index = &quot;hg19.fasta.fa&quot;,
      ref_dict = &quot;hg19.fasta.dict&quot;,
      ref_alt = &quot;hg19.fasta.alt&quot;,
      ref_amb = &quot;hg19.fasta.amb&quot;,
      ref_ann = &quot;hg19.fasta.ann&quot;,
      ref_bwt = &quot;hg19.fasta.bwt&quot;,
      ref_pac = &quot;hg19.fasta.pac&quot;,
      ref_sa = &quot;hg19.fasta.sa&quot;
  }

  output {
    File output_bam = BwaMem.output_bam
    File output_bai = BwaMem.output_bai
  }
}</code></pre>
<p>Tasks are constructed in the same WDL file by naming them and providing similar information. Here’s an example of a task that runs <code>bwa mem</code> on an interleaved fastq file using a Fred Hutch docker container. Notice there are sections for the relevant portions of the task, such as <code>input</code> (what files or variables are needed), <code>command</code> (or what it should run), <code>output</code> (which of the generated files is considered the output of the task), and <code>runtime</code> (such as what HPC resources and software should be used for this task).</p>
<pre><code>task BwaMem {
  input {
    File input_fastq
    String base_file_name
    File ref_fasta
    File ref_fasta_index
    File ref_dict
    File ref_alt
    File ref_amb
    File ref_ann
    File ref_bwt
    File ref_pac
    File ref_sa
  }
  command {

    bwa mem \
      -p -v 3 -t 16 -M \
      ${ref_fasta} ${input_fastq} &gt; ${base_file_name}.sam 
    samtools view -1bS -@ 15 -o ${base_file_name}.aligned.bam ${base_file_name}.sam
  }
  output {
    File output_bam = &quot;${base_file_name}.aligned.bam&quot;
    File output_bai = &quot;${base_file_name}.aligned.bam.bai&quot;
  }
  runtime {
    memory: &quot;32 GB&quot;
    cpu: 16
    docker: &quot;fredhutch/bwa:0.7.17&quot;
  }
}</code></pre>
<p>You can find more about constructing the rest of your workflow at the OpenWDL docs site, and in future content here.</p>
<div id="design-recommendations" class="section level3" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> Design Recommendations</h3>
<p>In order to improve shareability and also leverage the <code>fh.wdlR</code> package, we recommend you structure your WDL based workflows with the following input files:</p>
<ol style="list-style-type: decimal">
<li>Workflow Description file</li>
</ol>
<ul>
<li>in WDL format, a list of tools to be run in a sequence, likely several, otherwise using a workflow manager is not the right approach.<br />
</li>
<li>This file describes the process that is desired to occur every time the workflow is run.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Parameters file</li>
</ol>
<ul>
<li>in json format, a workflow-specific list of inputs and parameters that are intended to be set for every group of workflow executions.</li>
<li>Examples of what this input may include would be which genome to map to, reference data files to use, what environment modules to use, etc.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Batch file</li>
</ol>
<ul>
<li>in json format, is a list of data locations and any other sample/job-specific information the workflow needs. Ideally this would be relatively minimal so that the consistency of the analysis between input data sets are as similar as possible to leverage the strengths of a reproducible workflow. This file would be different for each batch or run of a workflow.<br />
</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Workflow options (OPTIONAL)</li>
</ol>
<ul>
<li>A json that contains information about how the workflow should be run (described below).</li>
</ul>
</div>
</div>
<div id="customizing-workflow-runs" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Customizing Workflow Runs</h2>
<p>You can tailor how a workflow might be run by various backends (computing infrastructure like a SLURM cluster or a cloud based compute provider), or with customized defaults.</p>
<div id="workflow-options" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Workflow Options</h3>
<p>You can find additional <a href="https://cromwell.readthedocs.io/en/stable/wf_options/Overview/">documentation on the Workflow Options json file</a> that can be used to customize how Cromwell runs your workflow. We’ll highlight some specific features that are often useful for many users.</p>
<p>Workflow options can be applied to any workflow to tune how the individual instance of the workflow should behave. There are more options than these that can be found in the Cromwell docs site, but of most interest are the following parameters:</p>
<ul>
<li><code>workflow_failure_mode</code>: <code>NoNewCalls</code> indicates that if one task fails, no new calls will be sent and all existing calls will be allowed to finish. <code>ContinueWhilePossible</code> indicates that even if one task fails, all other task series should be continued until all possible jobs are completed either successfully or not.</li>
<li><code>default_runtime_attributes.maxRetries</code>: The maximum number of times a job can be retried if it fails in a way that is considered a retryable failure (like if a job gets dumped or the server goes down).</li>
<li><code>write_to_cache</code>: Do you want to write metadata about this workflow to the database to allow for future use of the cached files it might create?</li>
<li><code>read_from_cache</code>: Do you want to query the database to determine if portions of this workflow have already completed successfully, thus they do not need to be re-computed.</li>
</ul>
</div>
<div id="runtime-defaults" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Runtime Defaults</h3>
<pre><code>{
    &quot;default_runtime_attributes&quot;: {
        &quot;docker&quot;: &quot;ubuntu:latest&quot;,
        &quot;continueOnReturnCode&quot;: [4, 8, 15, 16, 23, 42]
    }
}</code></pre>
</div>
<div id="call-caching" class="section level3" number="2.2.3">
<h3><span class="header-section-number">2.2.3</span> Call Caching</h3>
<pre><code>{
    &quot;write_to_cache&quot;: true,
    &quot;read_from_cache&quot;: true
}</code></pre>
</div>
<div id="workflow-failure-mode" class="section level3" number="2.2.4">
<h3><span class="header-section-number">2.2.4</span> Workflow Failure Mode</h3>
<pre><code>{
    &quot;workflow_failure_mode&quot;: &quot;ContinueWhilePossible&quot;
}</code></pre>
<p>Values are: <code>ContinueWhilePossible</code> or <code>NoNewCalls</code></p>
</div>
<div id="copying-outputs" class="section level3" number="2.2.5">
<h3><span class="header-section-number">2.2.5</span> Copying outputs</h3>
<p>Read more details <a href="https://cromwell.readthedocs.io/en/stable/wf_options/Overview/#output-copying">here</a>, but the ability to copy the workflow outputs to another location can be very useful for data management.</p>
<pre><code>{
    &quot;final_workflow_outputs_dir&quot;: &quot;/my/path/workflow/archive&quot;,
    &quot;use_relative_output_paths&quot;: false
}</code></pre>
<p>If you want to collapse the directory structure, you can set <code>use_relative_output_paths</code> to <code>true</code> but if a file collision occurs Cromwell will stop and report the workflow as failed.</p>

</div>
</div>
</div>
<hr>
<center> 
  <div class="footer">
      All illustrations <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY. </a>
      <br>
      All other materials <a href= "https://creativecommons.org/licenses/by/4.0/"> CC-BY </a> unless noted otherwise.
  </div>
</center>
            </section>

          </div>
        </div>
      </div>
<a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="developing-testing-and-scaling-workflows.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
